<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·å¤§å†’éšªï¼šå®Œç¾é¤ç›¤ç‰ˆ</title>
    
    <!-- React Framework -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f0f9ff; 
            overflow-x: hidden; 
            scroll-behavior: smooth; 
        }
        
        /* é¿å…å°èˆªé®æ“‹ */
        section { scroll-margin-top: 100px; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animation Keyframes */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }

        /* Blood Cell Animation */
        @keyframes flow { 0% { left: -20%; } 100% { left: 120%; } }
        .blood-cell { animation: flow 4s linear infinite; }
        .blood-cell.slow { animation: flow 10s linear infinite; }

        /* Digestive Track */
        @keyframes shake-stuck { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px) rotate(-2deg); } 75% { transform: translateX(2px) rotate(2deg); } }
        .stuck-effect { animation: shake-stuck 0.3s infinite; }

        /* Plate Animations */
        @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        .food-pop { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SVGs ---
        const Icons = {
            Menu: () => <svg className="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: () => <svg className="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Heart: () => <svg className="w-6 h-6 text-red-500 fill-current" viewBox="0 0 24 24"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Check: () => <svg className="w-6 h-6 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            ArrowRight: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            Sound: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>,
            Search: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        };

        // --- SUB COMPONENTS DEFINITIONS ---

        // GEMINI FEATURE 1: HEALTHY PLATE LAB (AI Recipe + TTS)
        const HealthyPlateLab = ({ updateHp, fetchGeminiContent, fetchGeminiTTS }) => {
            const [veggie, setVeggie] = useState(0); 
            const [protein, setProtein] = useState(0);
            const [carb, setCarb] = useState(0); 
            const [showGuide, setShowGuide] = useState(false);
            const [step, setStep] = useState(0); 
            
            // AI States
            const [recipe, setRecipe] = useState(null);
            const [recipeLoading, setRecipeLoading] = useState(false);
            const [ttsLoading, setTtsLoading] = useState(false);

            const isBalanced = veggie >= 4 && protein >= 2 && carb >= 2 && veggie <= 6 && protein <= 4 && carb <= 4;
            const isTooMuchCarb = carb > 2 && veggie < 4;
            const isTooMuchMeat = protein > 2 && veggie < 4;

            const resetPlate = () => {
                setVeggie(0);
                setProtein(0);
                setCarb(0);
                setRecipe(null); 
                updateHp(5);
            };

            const eatingSteps = [
                { text: "1. å…ˆåƒè”¬èœèˆ‡å–æ¹¯", desc: "å¢Šèƒƒã€å¢åŠ é£½è¶³æ„Ÿï¼Œç©©å®šè¡€ç³–ã€‚", icon: "ğŸ¥¦" },
                { text: "2. å†åƒè±†é­šè›‹è‚‰é¡", desc: "è£œå……è›‹ç™½è³ªï¼Œå¹«åŠ©è‚Œè‚‰ç”Ÿé•·ã€‚", icon: "ğŸ—" },
                { text: "3. æœ€å¾Œåƒç±³é£¯æ¾±ç²‰", desc: "å·²ç¶“åŠé£½äº†ï¼Œæ¾±ç²‰å°±ä¸æœƒåƒå¤ªå¤šï¼", icon: "ğŸš" }
            ];

            const generateRecipe = async () => {
                if (!isBalanced) return alert("è«‹å…ˆå®Œæˆå®Œç¾çš„ 211 é¤ç›¤å†ç”Ÿæˆé£Ÿè­œå–”ï¼");
                
                setRecipeLoading(true);
                setRecipe(null);
                
                const plateDescription = "ä¸€ä»½å‡è¡¡çš„åˆé¤ï¼Œæ¯”ä¾‹ç‚ºï¼šè”¬èœ 50%ï¼Œå„ªè³ªè›‹ç™½è³ª 25%ï¼Œå…¨ç©€ç‰©æ¾±ç²‰ 25%ã€‚";
                const userPrompt = `è«‹ç‚ºä¸€å€‹æ­£åœ¨å­¸ç¿’å¥åº·é£²é£Ÿçš„å°å­¸ç”Ÿè¨­è¨ˆä¸€é“ç°¡å–®ã€æœ‰è¶£ä¸”ç¾å‘³çš„åˆé¤é£Ÿè­œã€‚é€™é“èœå¿…é ˆç¬¦åˆä»¥ä¸‹ç‡Ÿé¤Šè¦æ±‚ï¼š${plateDescription} è«‹çµ¦å‡ºé£Ÿè­œåç¨±ã€æ‰€éœ€ææ–™å’Œç°¡å–®çš„æ­¥é©Ÿã€‚ä½¿ç”¨å¸å¼•å…’ç«¥çš„å£å»ï¼Œå­—æ•¸æ§åˆ¶åœ¨ 150 å­—ä»¥å…§ã€‚`;
                const systemInstruction = "ä½ æ˜¯ä¸€ä½å°ˆé–€ç‚ºå…’ç«¥è¨­è¨ˆå¥åº·é£Ÿè­œçš„é ‚ç´šç‡Ÿé¤Šå¸«ã€‚ä½ çš„å›ç­”å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡ï¼Œä¸”å£æ°£è¦å……æ»¿æ´»åŠ›å’Œé¼“å‹µã€‚è«‹ä¸è¦åŠ å…¥ä»»ä½• Markdown æ ¼å¼æˆ–æ¨™é¡Œï¼Œç›´æ¥è¼¸å‡ºé£Ÿè­œå…§å®¹ã€‚";
                
                const result = await fetchGeminiContent(userPrompt, systemInstruction);
                setRecipe(result.text);
                setRecipeLoading(false);
            };

            const playRecipe = async () => {
                if(!recipe) return;
                setTtsLoading(true);
                await fetchGeminiTTS(recipe);
                setTtsLoading(false);
            };

            return (
                <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-green-200 flex flex-col md:flex-row gap-8">
                    
                    {/* LEFT: THE PLATE INTERACTION */}
                    <div className="flex-1 flex flex-col items-center">
                        <div className="relative w-64 h-64 md:w-80 md:h-80 bg-slate-100 rounded-full border-8 border-white shadow-[0_0_20px_rgba(0,0,0,0.1)] overflow-hidden mb-6 relative">
                            {/* Visual Feedback Overlay */}
                            {isBalanced && <div className="absolute inset-0 z-20 border-8 border-yellow-400 rounded-full animate-pulse-glow pointer-events-none"></div>}
                            
                            {/* SECTIONS */}
                            <div className="absolute inset-0 flex flex-wrap">
                                {/* Top Half: Veggies (50%) */}
                                <div className="w-full h-1/2 bg-green-50 border-b border-white/50 relative flex items-center justify-center overflow-hidden">
                                    <span className="absolute text-green-200 font-bold text-4xl opacity-30 z-0">è”¬èœ 50%</span>
                                    {/* Filled Veggies */}
                                    <div className="flex flex-wrap items-center justify-center gap-1 p-4 z-10 w-full h-full content-center">
                                        {[...Array(veggie)].map((_, i) => <span key={i} className="text-2xl food-pop">ğŸ¥¦</span>)}
                                    </div>
                                </div>
                                
                                {/* Bottom Left: Protein (25%) */}
                                <div className="w-1/2 h-1/2 bg-red-50 border-r border-white/50 relative flex items-center justify-center overflow-hidden">
                                    <span className="absolute text-red-200 font-bold text-2xl opacity-30 z-0">è±†è‚‰ 25%</span>
                                    <div className="flex flex-wrap items-center justify-center gap-1 p-2 z-10 w-full h-full content-center">
                                        {[...Array(protein)].map((_, i) => <span key={i} className="text-2xl food-pop">ğŸ—</span>)}
                                    </div>
                                </div>

                                {/* Bottom Right: Carbs (25%) */}
                                <div className="w-1/2 h-1/2 bg-yellow-50 relative flex items-center justify-center overflow-hidden">
                                    <span className="absolute text-yellow-200 font-bold text-2xl opacity-30 z-0">é£¯ 25%</span>
                                    <div className="flex flex-wrap items-center justify-center gap-1 p-2 z-10 w-full h-full content-center">
                                        {[...Array(carb)].map((_, i) => <span key={i} className="text-2xl food-pop">ğŸš</span>)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* STATUS TEXT */}
                        <div className="text-center mb-6 h-12">
                            {isBalanced ? (
                                <div className="text-green-600 font-bold text-xl animate-bounce">âœ¨ å®Œç¾ï¼é€™å°±æ˜¯ 211 å¥åº·é¤ç›¤ï¼</div>
                            ) : isTooMuchCarb ? (
                                <div className="text-yellow-600 font-bold">âš ï¸ é£¯å¤ªå¤šäº†ï¼å®¹æ˜“æƒ³ç¡è¦ºå–”ï¼</div>
                            ) : isTooMuchMeat ? (
                                <div className="text-red-600 font-bold">âš ï¸ è‚‰å¤ªå¤šäº†ï¼è”¬èœè¦åŠ å€ï¼</div>
                            ) : (
                                <div className="text-slate-400 font-bold">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒæŠŠç›¤å­å¡«æ»¿ï¼</div>
                            )}
                        </div>

                        {/* CONTROLS */}
                        <div className="flex gap-2 w-full max-w-md">
                            <button onClick={() => setVeggie(v => Math.min(v+1, 6))} className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition-all">
                                + è”¬èœ
                            </button>
                            <button onClick={() => setProtein(v => Math.min(v+1, 4))} className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition-all">
                                + è±†è‚‰è›‹
                            </button>
                            <button onClick={() => setCarb(v => Math.min(v+1, 4))} className="flex-1 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-3 rounded-xl font-bold shadow-md active:scale-95 transition-all">
                                + é£¯éºµ
                            </button>
                        </div>
                        <button onClick={resetPlate} className="mt-4 text-slate-400 text-sm underline hover:text-slate-600">
                            æ¸…ç©ºé‡ä¾†
                        </button>
                    </div>

                    {/* RIGHT: EATING GUIDE & AI RECIPE */}
                    <div className="flex-1 bg-slate-50 rounded-2xl p-6 border border-slate-200 flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black text-slate-700">åƒé£¯é †åºå¤§è§£å¯†</h3>
                            <button onClick={() => setShowGuide(!showGuide)} className="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold">
                                {showGuide ? 'éš±è—ç¥•æŠ€' : 'é¡¯ç¤ºç¥•æŠ€'}
                            </button>
                        </div>

                        {showGuide ? (
                             <div className="space-y-4 flex-1">
                                {eatingSteps.map((s, i) => (
                                    <div key={i} className={`p-4 rounded-xl border-2 transition-all cursor-pointer ${step === i ? 'bg-white border-emerald-500 shadow-md scale-105' : 'bg-slate-100 border-transparent opacity-60'}`} onClick={() => setStep(i)}>
                                        <div className="flex items-center gap-4">
                                            <div className="text-3xl">{s.icon}</div>
                                            <div>
                                                <div className="font-bold text-slate-800">{s.text}</div>
                                                <div className="text-xs text-slate-500">{s.desc}</div>
                                            </div>
                                            {step === i && <div className="ml-auto"><Icons.Check /></div>}
                                        </div>
                                    </div>
                                ))}
                                <div className="mt-4 p-4 bg-yellow-50 text-yellow-800 rounded-xl text-sm font-bold border border-yellow-200">
                                    ğŸ’¡ å°æ’‡æ­¥ï¼šæ¯ä¸€å£éƒ½è¦å’¬ 20 ä¸‹ï¼Œè®“å¤§è…¦çŸ¥é“ä½ é£½äº†ï¼
                                </div>
                             </div>
                        ) : (
                            <div className="flex-1 flex items-center justify-center flex-col text-slate-400 cursor-pointer" onClick={() => setShowGuide(true)}>
                                <div className="text-6xl mb-4 animate-pulse">ğŸ¥—</div>
                                <p>ä½ çŸ¥é“ã€Œå…ˆåƒé£¯ã€é‚„æ˜¯ã€Œå…ˆåƒèœã€</p>
                                <p>æœƒæ±ºå®šä½ æœƒä¸æœƒè®Šèƒ–å—ï¼Ÿ</p>
                                <button className="mt-4 bg-emerald-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-emerald-600 transition-transform hover:scale-105">
                                    æ­æ›‰ç­”æ¡ˆ
                                </button>
                            </div>
                        )}

                        {/* AI RECIPE OUTPUT */}
                        <div className="mt-6 border-t border-slate-200 pt-6">
                            <h3 className="text-xl font-black text-slate-700 mb-3 flex items-center">
                                AI é£Ÿè­œå¤©æ‰ âœ¨
                            </h3>
                            <button 
                                onClick={generateRecipe} 
                                disabled={!isBalanced || recipeLoading}
                                className={`w-full py-3 rounded-xl font-bold transition-colors ${
                                    isBalanced && !recipeLoading ? 'bg-indigo-500 text-white hover:bg-indigo-600' : 'bg-gray-300 text-gray-600 cursor-not-allowed'
                                }`}
                            >
                                {recipeLoading ? 'ç”Ÿæˆä¸­...' : isBalanced ? 'ç”Ÿæˆå°ˆå±¬é£Ÿè­œï¼' : 'è«‹å…ˆå¹³è¡¡é¤ç›¤'}
                            </button>
                            
                            {recipe && (
                                <div className="mt-4 bg-white p-4 rounded-xl border border-indigo-200 text-sm whitespace-pre-wrap shadow-inner relative">
                                    <div className="flex justify-between items-center mb-2">
                                        <p className="font-bold text-indigo-700">AI æ¨è–¦ï¼š</p>
                                        <button 
                                            onClick={playRecipe}
                                            disabled={ttsLoading}
                                            className="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 p-2 rounded-full transition-colors disabled:opacity-50"
                                            title="å”¸çµ¦æˆ‘è½"
                                        >
                                            <Icons.Sound />
                                        </button>
                                    </div>
                                    <p>{recipe}</p>
                                    {ttsLoading && <div className="text-xs text-indigo-400 mt-2">èªéŸ³ç”Ÿæˆä¸­...</div>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- GEMINI FEATURE 2: CHAT DOJO (Refusal Script + TTS) ---
        const ChatDojoSection = ({ fetchGeminiContent, fetchGeminiTTS, updateHp }) => {
            const [step, setStep] = useState(0);
            const [scenarioInput, setScenarioInput] = useState('');
            const [script, setScript] = useState(null);
            const [scriptLoading, setScriptLoading] = useState(false);
            const [ttsLoading, setTtsLoading] = useState(false);

            const handleDecision = (decision) => {
                if (decision === 'win') {
                    setStep(2);
                    setScript(null);
                } else {
                    setStep(3);
                    updateHp(-20);
                }
            };

            const generateScript = async () => {
                if (!scenarioInput) return;
                
                setScriptLoading(true);
                setScript(null);

                const userPrompt = `è«‹ç‚ºæˆ‘è¨­è¨ˆä¸€å¥è°æ˜ã€æœ‰ç¦®è²Œä½†å …å®šçš„æ‹’çµ•å°è©ï¼Œä¾†æ‡‰å°ä»¥ä¸‹æƒ…å¢ƒï¼š"${scenarioInput}"ã€‚å°è©ä¸­è«‹åŒ…å«ã€Œå¥åº·ã€æˆ–ã€Œèº«é«”ã€ç›¸é—œçš„ç†ç”±ã€‚è®“é€™å¥è©±çœ‹èµ·ä¾†å¸¥æ°£åˆä¸æœƒå‚·åˆ°æœ‹å‹ã€‚å­—æ•¸ 50 å­—ä»¥å…§ã€‚`;
                const systemInstruction = "ä½ æ˜¯ä¸€ä½å°ˆé–€è¨“ç·´å…’ç«¥ç¤¾äº¤æŠ€å·§å’Œå¥åº·æ„è­˜çš„å°ˆå®¶ã€‚ä½ çš„å›ç­”å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡ï¼Œä¸¦æä¾›ä¸€å¥èƒ½å¤ è®“å°æ–¹èˆ’æœæ¥å—çš„æ‹’çµ•è©±è¡“ã€‚è«‹å‹¿ä½¿ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥è¼¸å‡ºå°è©ã€‚";
                
                const result = await fetchGeminiContent(userPrompt, systemInstruction);
                setScript(result.text);
                setScriptLoading(false);
            };

            const playScript = async () => {
                if(!script) return;
                setTtsLoading(true);
                await fetchGeminiTTS(script);
                setTtsLoading(false);
            };

            return (
                <div className="flex flex-col h-full justify-between">
                    <div className="space-y-4 mb-4 flex-1 overflow-y-auto max-h-64 p-2 bg-slate-50 rounded-xl">
                         <div className="flex items-start">
                            <div className="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center mr-3 font-bold text-gray-600">å‹</div>
                            <div className="bg-gray-200 p-4 rounded-2xl rounded-tl-none text-slate-700 max-w-[80%]">
                                {step === 0 ? "èª’ï¼æˆ‘è²·äº†è¶…è¾£çš„è¾£æ¢ï¼Œåƒä¸€æ ¹å•¦ï¼æ²’é—œä¿‚çš„ï¼" : step === 2 ? "å“‡...ä½ èªªå¾—å¥½åƒå¾ˆæœ‰é“ç†ï¼Œé‚£æˆ‘ä¹Ÿä¸åƒäº†ã€‚" : "å˜¿å˜¿ï¼Œæˆ‘å°±çŸ¥é“ä½ ä¸æ•¢æ‹’çµ•ï¼(HP -20)"}
                            </div>
                         </div>
                         {step === 2 && (
                             <div className="flex items-end justify-end">
                                <div className="bg-emerald-100 text-emerald-800 p-4 rounded-2xl rounded-tr-none max-w-[80%]">è¬è¬ï¼Œä½†æˆ‘ä¸æƒ³åƒã€‚é‚£äº›æ·»åŠ åŠ‘å°èº«é«”ä¸å¥½ï¼Œæˆ‘å€‘å»åƒæ°´æœå§ï¼</div>
                                <div className="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center ml-3 text-white font-bold">æˆ‘</div>
                             </div>
                         )}
                         {/* AI Generated Script Display */}
                         {script && (
                             <div className="flex items-end justify-end w-full">
                                <div className="bg-yellow-100 text-yellow-800 p-4 rounded-2xl rounded-tr-none max-w-[80%] border border-yellow-300 shadow-sm relative">
                                    <div className="flex justify-between items-start mb-1 gap-2">
                                        <span className="font-bold text-xs text-yellow-600 uppercase">AI æ™ºæ…§å°è©</span>
                                        <button onClick={playScript} disabled={ttsLoading} className="text-yellow-700 hover:text-yellow-900"><Icons.Sound /></button>
                                    </div>
                                    {script}
                                </div>
                                <div className="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center ml-3 text-white font-bold shrink-0">AI</div>
                             </div>
                         )}
                    </div>
                    
                    {/* INPUT / ACTION AREA */}
                    <div className="mt-4 border-t border-slate-200 pt-4">
                        {step === 0 ? (
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={() => handleDecision('win')} className="bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold">å …å®šæ‹’çµ• ğŸ˜</button>
                                <button onClick={() => handleDecision('lose')} className="bg-slate-300 hover:bg-slate-400 text-slate-700 py-3 rounded-xl font-bold">å‹‰å¼·æ¥å— ğŸ˜“</button>
                            </div>
                        ) : (
                            <button onClick={() => setStep(0)} className="w-full bg-indigo-100 text-indigo-600 py-3 rounded-xl font-bold">å†ä¾†ä¸€æ¬¡</button>
                        )}
                        
                        <div className="mt-4">
                            <h4 className="text-sm font-bold text-slate-600 mb-2 flex items-center">
                                AI æ‹’çµ•è©±è¡“ç”Ÿæˆå™¨ âœ¨
                            </h4>
                            <input
                                type="text"
                                placeholder="è¼¸å…¥æœ‹å‹å‹¸èªªçš„æƒ…å¢ƒï¼Œä¾‹å¦‚ï¼š'ä»–èªªä¸åƒå°±æ˜¯ä¸çµ¦é¢å­ï¼'"
                                value={scenarioInput}
                                onChange={(e) => setScenarioInput(e.target.value)}
                                className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm mb-2"
                            />
                            <button
                                onClick={generateScript}
                                disabled={!scenarioInput || scriptLoading}
                                className={`w-full py-2 rounded-lg text-sm font-bold transition-colors ${
                                    scenarioInput && !scriptLoading ? 'bg-yellow-500 text-black hover:bg-yellow-400' : 'bg-gray-300 text-gray-600 cursor-not-allowed'
                                }`}
                            >
                                {scriptLoading ? 'ç”Ÿæˆ AI å°è©ä¸­...' : 'ç”Ÿæˆ AI æ‹’çµ•å°è©'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW GEMINI FEATURE: AI BOSS BATTLE
        const BossBattle = ({ updateHp, fetchGeminiContent }) => {
            const [hp, setHp] = useState(100);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [loading, setLoading] = useState(false);
            const [gameWon, setGameWon] = useState(false);

            const initialQuestion = {
                q: "è¾£æ¢ç‚ºä»€éº¼é€™éº¼é¦™ï¼Ÿ",
                o: ["å…¨æ˜¯å¤©ç„¶é¦™æ–™", "åŠ äº†å¤§é‡äººå·¥é¦™ç²¾"],
                a: 1
            };

            useEffect(() => {
                if (!currentQuestion) setCurrentQuestion(initialQuestion);
            }, []);

            const generateQuestion = async () => {
                setLoading(true);
                const prompt = `Generate a JSON object for a multiple choice health trivia question for kids. 
                Fields required: 
                "q": The question string (in Traditional Chinese).
                "o": An array of 2 short strings for options (in Traditional Chinese).
                "a": The index of the correct option (0 or 1).
                Example: {"q": "åƒè˜‹æœè¦å‰Šçš®å—ï¼Ÿ", "o": ["è¦ï¼Œçš®æœ‰æ¯’", "ä¸ç”¨ï¼Œçš®æœ‰ç‡Ÿé¤Š"], "a": 1}
                Output ONLY valid JSON.`;
                
                try {
                    const result = await fetchGeminiContent(prompt, "You are a JSON generator. Output only valid JSON without markdown formatting.");
                    const cleanText = result.text.replace(/```json|```/g, '').trim();
                    const questionData = JSON.parse(cleanText);
                    if(questionData && questionData.q && questionData.o) {
                        setCurrentQuestion(questionData);
                    } else {
                        throw new Error("Invalid format");
                    }
                } catch (e) {
                    console.error("AI Question Failed", e);
                    // Fallback question
                    setCurrentQuestion({
                        q: "å–æ°´æœ€å¥½çš„æ™‚é–“æ˜¯ï¼Ÿ",
                        o: ["å£æ¸´æ‰å–", "éš¨æ™‚è£œå……"],
                        a: 1
                    });
                }
                setLoading(false);
            };

            const answer = (i) => {
                if (i === currentQuestion.a) {
                    const newHp = hp - 34;
                    setHp(newHp);
                    if (newHp <= 0) {
                        setGameWon(true);
                    } else {
                        generateQuestion(); // Fetch next question on success
                    }
                } else {
                    updateHp(-10);
                    alert("ç­”éŒ¯äº†ï¼è¢«é­”ç‹æ”»æ“Šï¼");
                }
            };

            return (
                <div className="text-center h-full flex flex-col justify-center">
                    {gameWon ? (
                        <div className="animate-bounce">
                            <div className="text-6xl mb-4">ğŸ†</div>
                            <h3 className="text-2xl font-bold text-yellow-400">å¤§å‹åˆ©ï¼</h3>
                            <button onClick={() => window.location.reload()} className="mt-4 px-6 py-2 bg-white text-black rounded-full font-bold">é‡ç©éŠæˆ²</button>
                        </div>
                    ) : (
                        <>
                            <div className="text-8xl mb-4 relative">
                                ğŸ‘¹
                                <div className="absolute -bottom-4 left-1/2 -translate-x-1/2 w-32 h-3 bg-gray-700 rounded-full overflow-hidden border border-gray-500">
                                    <div className="h-full bg-red-500 transition-all" style={{width: `${hp}%`}}></div>
                                </div>
                            </div>
                            
                            <div className="bg-slate-800 p-6 rounded-2xl border border-slate-600 mt-4 min-h-[200px] flex flex-col justify-center">
                                {loading ? (
                                    <div className="text-cyan-400 animate-pulse font-bold">é­”ç‹æ­£åœ¨æ€è€ƒé‚ªæƒ¡çš„å•é¡Œ...</div>
                                ) : currentQuestion ? (
                                    <>
                                        <p className="text-xl font-bold mb-6 text-white">{currentQuestion.q}</p>
                                        <div className="grid grid-cols-2 gap-4">
                                            {currentQuestion.o.map((opt, i) => (
                                                <button key={i} onClick={() => answer(i)} className="bg-slate-700 hover:bg-indigo-600 py-4 rounded-xl font-bold transition-colors text-lg text-cyan-50">
                                                    {opt}
                                                </button>
                                            ))}
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-red-400">é­”ç‹é€£ç·šéŒ¯èª¤...</div>
                                )}
                            </div>
                            <div className="mt-2 text-xs text-slate-500">AI éš¨æ©Ÿå‡ºé¡Œä¸­ âœ¨</div>
                        </>
                    )}
                </div>
            );
        };

        // NEW GEMINI FEATURE: HERO STORY GENERATOR
        const HeroStorySection = ({ fetchGeminiContent }) => {
            const [name, setName] = useState("");
            const [weapon, setWeapon] = useState("");
            const [story, setStory] = useState("");
            const [loading, setLoading] = useState(false);

            const generateStory = async () => {
                if(!name || !weapon) return;
                setLoading(true);
                setStory("");

                const prompt = `Create a short, exciting superhero story (max 100 words) for a kid named "${name}".
                Their special weapon is "${weapon}".
                The enemy is a "Junk Food Monster" (e.g., Grease Goblin, Sugar Demon).
                The story should be action-packed but funny.
                Language: Traditional Chinese.`;

                const result = await fetchGeminiContent(prompt, "You are a storyteller for kids.");
                setStory(result.text);
                setLoading(false);
            };

            return (
                <div className="bg-gradient-to-r from-cyan-500 to-blue-600 p-8 rounded-3xl text-white shadow-lg">
                    <h2 className="text-3xl font-black mb-6 text-center">ğŸ¦¸ å¥åº·è‹±é›„å‚³èªª</h2>
                    <div className="flex flex-col md:flex-row gap-4 mb-6">
                        <input 
                            type="text" 
                            placeholder="ä½ çš„è‹±é›„åå­—" 
                            value={name} 
                            onChange={e => setName(e.target.value)}
                            className="flex-1 px-4 py-3 rounded-xl text-slate-800 font-bold focus:outline-none focus:ring-4 focus:ring-yellow-400"
                        />
                        <input 
                            type="text" 
                            placeholder="ä½ çš„å¥åº·æ­¦å™¨ (ä¾‹: èŠ±æ¤°èœåŠ)" 
                            value={weapon} 
                            onChange={e => setWeapon(e.target.value)}
                            className="flex-1 px-4 py-3 rounded-xl text-slate-800 font-bold focus:outline-none focus:ring-4 focus:ring-yellow-400"
                        />
                        <button 
                            onClick={generateStory} 
                            disabled={loading || !name || !weapon}
                            className="bg-yellow-400 hover:bg-yellow-300 text-yellow-900 px-8 py-3 rounded-xl font-black shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:scale-100"
                        >
                            {loading ? "æ’°å¯«ä¸­..." : "ç”Ÿæˆå‚³èªª"}
                        </button>
                    </div>
                    
                    {story && (
                        <div className="bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/30 text-lg leading-relaxed font-medium animate-in slide-in-from-bottom-4">
                            {story}
                        </div>
                    )}
                </div>
            );
        };

        const PledgeSection = () => {
            const [name, setName] = useState("");
            const [done, setDone] = useState(false);
            return (
                <section className="py-16 px-6 bg-gradient-to-br from-emerald-600 to-teal-700 text-white text-center">
                    <div className="max-w-2xl mx-auto">
                        <h2 className="text-3xl font-black mb-4">ğŸ“œ å¥åº·å®£èª“ç‰†</h2>
                        {!done ? (
                            <div className="bg-white/10 backdrop-blur-sm p-8 rounded-3xl border border-white/20">
                                <p className="text-xl font-bold mb-6">æˆ‘é¡˜æ„ç‚ºäº†å¥åº·çš„èº«é«”ï¼Œæ‹’çµ•åƒåœ¾é£Ÿç‰©ï¼</p>
                                <input type="text" placeholder="è¼¸å…¥ä½ çš„åå­—" value={name} onChange={e=>setName(e.target.value)} className="w-full text-center py-3 rounded-xl text-slate-800 font-bold text-xl mb-6" />
                                <button onClick={() => {if(name) setDone(true)}} className="bg-yellow-400 hover:bg-yellow-300 text-yellow-900 px-8 py-3 rounded-xl font-black text-xl shadow-lg transition-transform hover:scale-105">è“‹ç« å®£èª“ ğŸ’®</button>
                            </div>
                        ) : (
                            <div className="bg-white text-slate-800 p-10 rounded-3xl shadow-2xl transform rotate-1 border-8 border-yellow-400 relative">
                                <h3 className="text-2xl font-black text-emerald-600 mb-2">å¥åº·å®ˆè­·è€…è­‰æ›¸</h3>
                                <p className="text-lg mb-2">èŒ²è­‰æ˜</p>
                                <p className="text-4xl font-black mb-4 border-b-4 border-slate-200 inline-block px-8 pb-2">{name}</p>
                                <p className="text-lg">å·²é€šéå¤§å†’éšªï¼Œæˆç‚ºå¥åº·å°è‹±é›„ï¼</p>
                                <div className="absolute top-4 right-8 w-24 h-24 border-4 border-red-500 rounded-full flex items-center justify-center text-red-500 text-xl font-black transform -rotate-12 opacity-80">åˆæ ¼</div>
                            </div>
                        )}
                    </div>
                </section>
            );
        };

        const BloodVesselSection = () => {
            const [fat, setFat] = useState(0);
            return (
                <div>
                    <div className="relative h-40 bg-red-200 rounded-2xl border-4 border-red-300 overflow-hidden mb-6 shadow-inner isolate">
                        {[...Array(6)].map((_, i) => (
                            <div key={i} className={`absolute w-8 h-8 bg-red-600 rounded-full shadow-sm blood-cell ${fat > 5 ? 'slow' : ''}`} style={{top: `${20 + Math.random()*60}%`, animationDelay: `${i}s`}}></div>
                        ))}
                        <div className="absolute top-0 w-full bg-yellow-400 transition-all duration-500 opacity-90 border-b-2 border-yellow-500" style={{height: `${fat*5}%`}}></div>
                        <div className="absolute bottom-0 w-full bg-yellow-400 transition-all duration-500 opacity-90 border-t-2 border-yellow-500" style={{height: `${fat*5}%`}}></div>
                    </div>
                    <div className="flex gap-4">
                        <button onClick={() => setFat(f => Math.min(f+1, 9))} className="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all">
                            åƒè¾£æ¢ ğŸ§§
                        </button>
                        <button onClick={() => setFat(0)} className="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all">
                            åƒè”¬èœæ’æ¯’ ğŸ¥—
                        </button>
                    </div>
                    <p className="text-center text-sm text-red-400 mt-3 font-bold">è¡€ç®¡é˜»å¡åº¦ï¼š{fat * 10}%</p>
                </div>
            );
        };

        const LatiaoLab = ({ updateHp }) => {
            const [count, setCount] = useState(1);
            const [xray, setXray] = useState(false);
            return (
                <div className="flex flex-col h-full justify-between">
                    <div className="relative bg-white rounded-2xl p-6 text-center border border-slate-200 mb-6 h-40 flex items-center justify-center overflow-hidden">
                        <div className={`text-8xl transition-all duration-500 ${xray ? 'blur-sm opacity-20' : ''}`}>ğŸ§§</div>
                        {xray && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center">
                                <span className="bg-black text-red-500 font-mono font-bold px-2 py-1 mb-2 animate-pulse rounded">âš ï¸ é«˜éˆ‰ High Sodium</span>
                                <span className="bg-black text-red-500 font-mono font-bold px-2 py-1 animate-pulse rounded">âš ï¸ æ·»åŠ åŠ‘ Additives</span>
                            </div>
                        )}
                        <button onClick={() => setXray(!xray)} className="absolute top-2 right-2 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded-full font-bold">
                            {xray ? 'é—œé–‰ X å…‰' : 'é–‹å•Ÿ X å…‰'}
                        </button>
                    </div>
                    <div>
                        <input type="range" min="1" max="10" value={count} 
                            onChange={(e) => {
                                const val = parseInt(e.target.value);
                                if(val > count) updateHp(-5);
                                setCount(val);
                            }} 
                            className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500 mb-6" 
                        />
                        <div className="grid grid-cols-2 gap-4 text-center">
                            <div className="bg-blue-50 p-3 rounded-xl">
                                <div className="text-3xl font-black text-blue-600">{(count * 1.5).toFixed(1)}</div>
                                <div className="text-sm text-blue-400 font-bold">ç¢—ç™½é£¯ç†±é‡</div>
                            </div>
                            <div className="bg-orange-50 p-3 rounded-xl">
                                <div className="text-3xl font-black text-orange-500">{count * 15}</div>
                                <div className="text-sm text-orange-400 font-bold">éœ€è·‘æ“å ´(åœˆ)</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const FaceSimulator = () => {
            const [zits, setZits] = useState([]);
            const addZit = (e) => {
                const rect = e.target.getBoundingClientRect();
                setZits([...zits, { x: e.clientX - rect.left, y: e.clientY - rect.top, id: Date.now() }]);
            };
            return (
                <div className="text-center">
                    <p className="text-sm text-orange-600 mb-4 font-bold">é»æ“Šè‡‰éƒ¨é¤µé£Ÿè¾£æ¢ï¼Œå°å¿ƒå‰¯ä½œç”¨ï¼</p>
                    <div onClick={addZit} className="relative w-48 h-48 mx-auto bg-[#ffdbac] rounded-full border-4 border-[#e0b586] cursor-pointer shadow-xl overflow-hidden active:scale-95 transition-transform">
                        <div className="absolute top-14 left-10 w-4 h-4 bg-slate-800 rounded-full"></div>
                        <div className="absolute top-14 right-10 w-4 h-4 bg-slate-800 rounded-full"></div>
                        <div className={`absolute bottom-10 left-1/2 -translate-x-1/2 w-16 h-2 bg-slate-800 transition-all duration-300 ${zits.length > 5 ? 'rotate-12 top-32 rounded-full h-6 w-6 border-4 border-slate-800 bg-red-900' : 'rounded-full'}`}></div>
                        <div className="absolute inset-0 bg-yellow-500 mix-blend-multiply pointer-events-none transition-opacity duration-500" style={{ opacity: Math.min(zits.length * 0.1, 0.8) }}></div>
                        {zits.map(z => (
                            <div key={z.id} className="absolute w-5 h-5 bg-red-500 rounded-full border-2 border-red-800 shadow-md animate-pulse" style={{top: z.y-10, left: z.x-10}}>
                                <div className="w-1.5 h-1.5 bg-yellow-100 rounded-full absolute top-1 left-1"></div>
                            </div>
                        ))}
                    </div>
                    <button onClick={() => setZits([])} className="mt-6 bg-white border-2 border-orange-200 text-orange-600 px-6 py-2 rounded-full font-bold hover:bg-orange-50 transition-colors">
                        ä½¿ç”¨æ´—é¢ä¹³ (é‡ç½®)
                    </button>
                </div>
            );
        };

        // NEW GEMINI FEATURE: FUTURE SELF CHAT
        const TimeMachineSection = ({ age, setAge, hp, fetchGeminiContent }) => {
            const [question, setQuestion] = useState("");
            const [answer, setAnswer] = useState("");
            const [loading, setLoading] = useState(false);

            const askFutureSelf = async () => {
                if(!question) return;
                setLoading(true);
                setAnswer("");
                
                const healthStatus = hp > 80 ? "éå¸¸å¥½ï¼Œå……æ»¿æ´»åŠ›" : hp > 50 ? "æ™®é€šï¼Œæœ‰æ™‚æœƒç´¯" : "å¾ˆå·®ï¼Œç¶“å¸¸ç”Ÿç—…";
                const futureAge = 10 + parseInt(age / 100 * 50); // Rough age estimate
                
                const prompt = `ä½ ç¾åœ¨æ‰®æ¼”ä½¿ç”¨è€… ${futureAge} å¹´å¾Œçš„è‡ªå·±ã€‚
                æ ¹æ“šä½¿ç”¨è€…ç›®å‰çš„å¥åº·åˆ†æ•¸ï¼ˆ${hp}åˆ†ï¼Œæ»¿åˆ†100ï¼‰ï¼Œä½ çš„å¥åº·ç‹€æ³æ˜¯ï¼š${healthStatus}ã€‚
                å¦‚æœåˆ†æ•¸é«˜ï¼Œä½ å¾ˆæ„Ÿè¬ç¾åœ¨çš„ä»–ï¼›å¦‚æœåˆ†æ•¸ä½ï¼Œä½ æœƒæŠ±æ€¨èº«é«”å“ªè£¡ç—›æˆ–å¾Œæ‚”ä»¥å‰äº‚åƒã€‚
                ä½¿ç”¨è€…å•ä½ ï¼šã€Œ${question}ã€
                è«‹ç”¨å¹½é»˜ã€æœ‰é»èª‡å¼µçš„èªæ°£å›ç­”ï¼Œå­—æ•¸ 50 å­—ä»¥å…§ã€‚`;

                const result = await fetchGeminiContent(prompt, "ä½ æ˜¯ä¸€å€‹ä¾†è‡ªæœªä¾†çš„æ™‚å…‰æ—…äººï¼Œæ­£åœ¨è·Ÿå°æ™‚å€™çš„è‡ªå·±å°è©±ã€‚");
                setAnswer(result.text);
                setLoading(false);
            };

            return (
                <div className="text-center h-full flex flex-col justify-between">
                    <p className="text-sm text-cyan-200 mb-4">æ‹–å‹•ä¸‹æ–¹æ»‘æ¡¿ï¼Œç©¿è¶Šåˆ° 10 å¹´å¾Œ...</p>
                    <div className="relative w-48 h-48 mx-auto rounded-2xl overflow-hidden border-4 border-cyan-700 shadow-2xl bg-gray-800 mb-4">
                        <div className="absolute inset-0 flex items-center justify-center flex-col bg-slate-700">
                            <span className="text-7xl filter brightness-110">ğŸ‘¶</span>
                            <span className="text-sm text-white font-bold mt-2">ç¾åœ¨çš„ä½ </span>
                        </div>
                        <div className="absolute inset-0 flex items-center justify-center flex-col bg-gray-900" style={{ opacity: age / 100 }}>
                            <span className="text-7xl filter grayscale contrast-150">ğŸ‘´</span>
                            <span className="text-sm text-gray-400 font-bold mt-2">æœªä¾†çš„ä½ </span>
                        </div>
                    </div>
                    
                    <input type="range" value={age} onChange={(e) => setAge(e.target.value)} className="w-full h-3 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-cyan-400 mb-6" />

                    {/* Chat Interface */}
                    <div className="bg-slate-700 rounded-xl p-3 text-left">
                        <div className="text-xs text-cyan-300 font-bold mb-2">ğŸ”® å‚³é€è¨Šæ¯çµ¦æœªä¾†çš„è‡ªå·±</div>
                        {answer && (
                            <div className="bg-cyan-900/50 p-2 rounded-lg mb-2 text-sm text-cyan-100 border border-cyan-700/50">
                                <span className="mr-2">ğŸ‘´:</span>{answer}
                            </div>
                        )}
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={question}
                                onChange={e => setQuestion(e.target.value)}
                                placeholder="å•å•æœªä¾†ï¼šæˆ‘é•·é«˜äº†å—ï¼Ÿ"
                                className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-2 py-1 text-sm text-white focus:outline-none focus:border-cyan-500"
                            />
                            <button 
                                onClick={askFutureSelf}
                                disabled={loading}
                                className="bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1 rounded-lg text-xs font-bold disabled:opacity-50"
                            >
                                {loading ? 'å‚³é€ä¸­...' : 'å‚³é€'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW GEMINI FEATURE: FOOD DETECTIVE
        const FoodDetectiveSection = ({ fetchGeminiContent, fetchGeminiTTS }) => {
            const [food, setFood] = useState("");
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [ttsLoading, setTtsLoading] = useState(false);

            const analyzeFood = async () => {
                if(!food) return;
                setLoading(true);
                setAnalysis(null);
                
                const prompt = `åˆ†æé£Ÿç‰©ï¼šã€Œ${food}ã€ã€‚
                1. çµ¦ä¸€å€‹å¥åº·åˆ†æ•¸ (1-100)ã€‚
                2. æ‰¾å‡ºèº«é«”è£¡çš„ã€Œå«Œç–‘çŠ¯ã€(å£æˆåˆ†ï¼Œå¦‚ç³–ã€åå¼è„‚è‚ª)ã€‚
                3. æ‰¾å‡ºã€Œç›®æ“Šè€…ã€(å¥½ç‡Ÿé¤Šï¼Œå¦‚çº–ç¶­ã€è›‹ç™½è³ª)ã€‚
                4. çµ¦ä¸€å€‹çŸ­çŸ­çš„åµæ¢çµæ¡ˆå ±å‘Š (30å­—å…§)ã€‚
                æ ¼å¼ï¼š
                åˆ†æ•¸ï¼š[åˆ†æ•¸]
                å«Œç–‘çŠ¯ï¼š[å…§å®¹]
                ç›®æ“Šè€…ï¼š[å…§å®¹]
                çµæ¡ˆï¼š[å…§å®¹]`;

                const result = await fetchGeminiContent(prompt, "ä½ æ˜¯ä¸€ä½åš´æ ¼ä½†å¹½é»˜çš„é£Ÿç‰©åµæ¢ï¼Œå°ˆé–€èª¿æŸ¥é£Ÿç‰©å°å°æœ‹å‹èº«é«”çš„å½±éŸ¿ã€‚");
                setAnalysis(result.text);
                setLoading(false);
            };

            const playAnalysis = async () => {
                if(!analysis) return;
                setTtsLoading(true);
                await fetchGeminiTTS(analysis);
                setTtsLoading(false);
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            value={food}
                            onChange={e => setFood(e.target.value)}
                            placeholder="è¼¸å…¥é£Ÿç‰©åç¨± (ä¾‹: ç‚¸é›)"
                            className="flex-1 px-4 py-2 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none"
                        />
                        <button 
                            onClick={analyzeFood}
                            disabled={loading || !food}
                            className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-xl transition-colors disabled:bg-slate-300"
                        >
                            <Icons.Search />
                        </button>
                    </div>

                    <div className="flex-1 bg-slate-50 rounded-2xl p-6 border-2 border-dashed border-slate-300 flex items-center justify-center relative overflow-hidden">
                        {loading ? (
                            <div className="text-center">
                                <div className="text-4xl animate-bounce mb-2">ğŸ•µï¸â€â™‚ï¸</div>
                                <div className="text-slate-500 font-bold">åµæ¢èª¿æŸ¥ä¸­...</div>
                            </div>
                        ) : analysis ? (
                            <div className="w-full h-full text-left overflow-y-auto">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-black text-indigo-800 text-lg">èª¿æŸ¥å ±å‘Š</h4>
                                    <button onClick={playAnalysis} disabled={ttsLoading} className="text-indigo-600 hover:bg-indigo-100 p-2 rounded-full">
                                        <Icons.Sound />
                                    </button>
                                </div>
                                <div className="text-slate-700 whitespace-pre-wrap font-medium leading-relaxed">
                                    {analysis}
                                </div>
                            </div>
                        ) : (
                            <div className="text-slate-400 text-center">
                                <div className="text-4xl mb-2 opacity-50">ğŸ“</div>
                                <p>è¼¸å…¥é£Ÿç‰©åç¨±</p>
                                <p>æŸ¥çœ‹åµæ¢æª”æ¡ˆ</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const MiniGame = ({ updateHp }) => {
            const [playing, setPlaying] = useState(false);
            const [score, setScore] = useState(0);
            const [fallingItems, setFallingItems] = useState([]); // ITEMS ARE NOW IN STATE
            const basketRef = useRef(50); // Basket position is still a ref
            
            // Game Loop Effect - Now uses functional state updates for stability
            useEffect(() => {
                if (!playing) return;
                
                const interval = setInterval(() => {
                    // è²æ˜åœ¨å¤–éƒ¨ï¼Œç”¨æ–¼åœ¨ setFallingItems ä¹‹å¾Œè§¸ç™¼å‰¯ä½œç”¨
                    let damageChange = 0;
                    let scoreChange = 0;

                    setFallingItems(prevItems => {
                        let newItems = [...prevItems];
                        
                        // 1. Spawn
                        if (Math.random() < 0.08) {
                            newItems.push({ id: Date.now(), x: Math.random() * 90 + 5, y: 0, type: Math.random() > 0.4 ? 'bad' : 'good' });
                        }
                        
                        // 2. Move
                        newItems = newItems.map(item => ({ ...item, y: item.y + 2.5 }));

                        // 3. Filter and Tally side effects (Mutating outer variables, but safe within setInterval's async context)
                        newItems = newItems.filter(item => {
                            const caught = item.y > 80 && item.y < 95 && Math.abs(item.x - basketRef.current) < 15;
                            if (caught) {
                                if (item.type === 'good') {
                                    damageChange += 5; // Heal
                                    scoreChange += 10;
                                } else {
                                    damageChange -= 10; // Damage
                                }
                                return false; // Remove item
                            }
                            return item.y < 100; // Remove if out of bounds
                        });
                        
                        // Return the new items array (Pure function result)
                        return newItems;
                    });
                    
                    // 4. Apply side effects sequentially and synchronously after setFallingItems completes
                    if (damageChange !== 0) {
                        updateHp(damageChange); 
                    }
                    if (scoreChange > 0) {
                        setScore(s => s + scoreChange); 
                    }

                }, 30); // ~33 FPS

                return () => clearInterval(interval);
            }, [playing, updateHp]); // updateHp å¿…é ˆä½œç‚ºä¾è³´é …

            const startGame = () => {
                setScore(0);
                setFallingItems([]);
                setPlaying(true);
            };

            return (
                <div className="relative rounded-3xl overflow-hidden border-4 border-indigo-700 shadow-2xl bg-slate-800 h-96 touch-none">
                     <div className="absolute top-4 left-6 z-10">
                        <h2 className="text-3xl font-black text-white drop-shadow-md">ğŸ® ç‡Ÿé¤Šæ¥æ¥æ¨‚</h2>
                        <p className="text-indigo-300">å·¦å³æ»‘å‹•æ¥ä½è˜‹æœï¼Œé¿é–‹è¾£æ¢ï¼</p>
                    </div>
                    <div className="absolute top-4 right-6 z-10 text-4xl font-mono text-yellow-400 font-bold drop-shadow-md">{score}</div>
                    
                    <div className="w-full h-full relative"
                        onMouseMove={e => { 
                            if(!playing) return;
                            const rect = e.currentTarget.getBoundingClientRect(); 
                            basketRef.current = ((e.clientX - rect.left) / rect.width) * 100; 
                        }}
                        onTouchMove={e => { 
                            if(!playing) return;
                            const rect = e.currentTarget.getBoundingClientRect(); 
                            basketRef.current = ((e.touches[0].clientX - rect.left) / rect.width) * 100; 
                        }}
                    >
                        {!playing && (
                            <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-20 backdrop-blur-sm">
                                <button onClick={startGame} className="bg-yellow-500 hover:bg-yellow-400 text-black text-xl font-black py-4 px-12 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.6)] hover:scale-105 transition-transform">é–‹å§‹éŠæˆ² START</button>
                            </div>
                        )}

                        {/* Items are now rendered from state: fallingItems */}
                        {fallingItems.map(i => (
                            <div 
                                key={i.id} 
                                className="absolute text-5xl transform -translate-x-1/2 will-change-transform" 
                                style={{top: `${i.y}%`, left: `${i.x}%`}}
                            >
                                {i.type === 'good' ? 'ğŸ' : 'ğŸ¥¢'}
                            </div>
                        ))}

                        {/* Basket (Uses basketRef for dynamic position) */}
                        <div 
                            className="absolute bottom-4 text-6xl transform -translate-x-1/2 transition-transform duration-75 ease-out" 
                            style={{left: `${basketRef.current}%`}}
                        >
                            ğŸ§º
                        </div>
                    </div>
                </div>
            );
        };


        // --- MAIN APP ---
        const App = () => {
            const [hp, setHp] = useState(100);
            const [menuOpen, setMenuOpen] = useState(false);
            const [timeMachineAge, setTimeMachineAge] = useState(0); // Lifted state

            // Gemini API Setup
            const apiKey = ""; // The execution environment provides the key at runtime
            const LLM_MODEL = 'gemini-2.5-flash-preview-09-2025';
            const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`;
            const TTS_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;

            // Helper: PCM to WAV Header
            // Gemini Flash TTS returns raw PCM 24kHz. We need to wrap it in WAV container for browser playback.
            const getWavHeader = (bufferLength, sampleRate = 24000) => {
                const buffer = new ArrayBuffer(44);
                const view = new DataView(buffer);
                
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };

                writeString(0, 'RIFF');
                view.setUint32(4, 36 + bufferLength, true); // File size
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true); // Subchunk1Size
                view.setUint16(20, 1, true); // PCM
                view.setUint16(22, 1, true); // Mono
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true); // ByteRate
                view.setUint16(32, 2, true); // BlockAlign
                view.setUint16(34, 16, true); // BitsPerSample
                writeString(36, 'data');
                view.setUint32(40, bufferLength, true);
                
                return buffer;
            };

            // Helper function for Gemini TTS
            const fetchGeminiTTS = async (textToSay) => {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: textToSay }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
                        }
                    };
                    const response = await fetch(TTS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error("TTS API Error");
                    const result = await response.json();
                    const audioContent = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    
                    if (audioContent) {
                        const binaryString = window.atob(audioContent);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        
                        const wavHeader = getWavHeader(len);
                        const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(blob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                    }
                } catch (e) {
                    console.error("TTS Failed:", e);
                    alert("èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
            };

            // Helper function for Gemini API calls
            const fetchGeminiContent = async (prompt, systemInstruction) => {
                for (let attempt = 0; attempt < 3; attempt++) {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] },
                        };

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API error: ${response.statusText}`);
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•ç”Ÿæˆå…§å®¹ã€‚";
                        return { text: text, success: true };

                    } catch (error) {
                        console.error(`Gemini API attempt ${attempt + 1} failed:`, error);
                        if (attempt < 2) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                        } else {
                            return { text: "æŠ±æ­‰ï¼Œé€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", success: false };
                        }
                    }
                }
            };
            
            // Safer HP Setter
            const updateHp = (amount) => {
                setHp(prev => Math.min(Math.max(prev + amount, 0), 100));
            };

            const sections = [
                { id: 'plate', title: 'ğŸ½ï¸ å®Œç¾é¤ç›¤å¯¦é©—å®¤' },
                { id: 'detective', title: 'ğŸ•µï¸â€â™‚ï¸ é£Ÿç‰©åµæ¢ç¤¾' },
                { id: 'digest', title: 'ğŸ« è…¸èƒƒé“å¤§å†’éšª' },
                { id: 'factory', title: 'ğŸ­ ææ€–çœŸç›¸å·¥å» ' },
                { id: 'simulations', title: 'ğŸ©¸ æ¨¡æ“¬å¯¦é©—å®¤' },
                { id: 'effects', title: 'ğŸ§Ÿ è®Šè‡‰èˆ‡æ™‚å…‰æ©Ÿ' },
                { id: 'game', title: 'ğŸ® ç‡Ÿé¤Šæ¥æ¥æ¨‚' },
                { id: 'chat', title: 'ğŸ’¬ æ‹’çµ•èª˜æƒ‘é“å ´' },
                { id: 'boss', title: 'âš”ï¸ æœ€çµ‚é­”ç‹' },
                { id: 'hero', title: 'ğŸ¦¸ å¥åº·è‹±é›„å‚³èªª' },
            ];

            const scrollTo = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth' });
                    setMenuOpen(false);
                }
            };

            return (
                <div className="w-full max-w-5xl mx-auto min-h-screen relative pb-20 bg-white shadow-2xl my-0 md:my-8 rounded-none md:rounded-[3rem] overflow-hidden border-x border-slate-200">
                    
                    {/* --- HEADER BAR (Sticky) --- */}
                    <div className="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-b border-slate-200 shadow-sm transition-all duration-300">
                        <div className="max-w-5xl mx-auto px-6 py-3 flex items-center justify-between">
                            
                            {/* Logo / Title */}
                            <div className="flex items-center space-x-2 cursor-pointer" onClick={() => window.scrollTo(0,0)}>
                                <div className="bg-emerald-500 text-white p-2 rounded-lg font-black text-xl">H</div>
                                <span className="font-bold text-slate-700 hidden sm:block">å¥åº·å¤§å†’éšª</span>
                            </div>

                            {/* HP Bar */}
                            <div className="flex-1 max-w-md mx-6">
                                <div className="flex justify-between text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">
                                    <span>Health Points</span>
                                    <span>{Math.round(hp)}%</span>
                                </div>
                                <div className="h-4 bg-slate-100 rounded-full overflow-hidden border border-slate-300 relative shadow-inner">
                                    <div 
                                        className={`h-full transition-all duration-500 ease-out ${hp < 30 ? 'bg-red-500 animate-pulse' : 'bg-gradient-to-r from-emerald-400 to-green-600'}`} 
                                        style={{ width: `${hp}%` }}
                                    ></div>
                                </div>
                            </div>

                            {/* Menu Button */}
                            <button 
                                onClick={() => setMenuOpen(!menuOpen)}
                                className="p-2 rounded-full hover:bg-slate-100 active:scale-95 transition-transform"
                            >
                                {menuOpen ? <Icons.X /> : <Icons.Menu />}
                            </button>
                        </div>

                        {/* Dropdown Menu */}
                        {menuOpen && (
                            <div className="absolute top-full left-0 w-full bg-white/95 backdrop-blur-xl border-b border-slate-200 shadow-xl p-4 flex flex-col items-center animate-in slide-in-from-top-2">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-4xl">
                                    {sections.map(sec => (
                                        <button 
                                            key={sec.id} 
                                            onClick={() => scrollTo(sec.id)}
                                            className="p-4 bg-slate-50 hover:bg-emerald-50 hover:text-emerald-600 rounded-xl font-bold text-slate-600 transition-colors text-center border border-slate-100"
                                        >
                                            {sec.title}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* --- HERO SECTION --- */}
                    <header className="pt-32 pb-12 px-8 text-center bg-gradient-to-b from-blue-50 via-white to-white relative overflow-hidden">
                        <div className="absolute top-10 left-10 w-64 h-64 bg-emerald-200 rounded-full blur-3xl opacity-30 animate-float"></div>
                        <div className="absolute bottom-10 right-10 w-64 h-64 bg-yellow-200 rounded-full blur-3xl opacity-30 animate-float" style={{animationDelay: '1.5s'}}></div>
                        
                        <div className="relative z-10 max-w-3xl mx-auto">
                            <span className="inline-block py-1 px-3 rounded-full bg-emerald-100 text-emerald-800 text-sm font-bold mb-4">Gemini AI Edition âœ¨</span>
                            <h1 className="text-4xl md:text-6xl font-black text-slate-800 mb-6 tracking-tight leading-tight">
                                èº«é«”ä¿è¡›æˆ°
                                <span className="block text-xl md:text-3xl text-emerald-600 mt-2 font-bold">å­¸æœƒåƒå°é£Ÿç‰©ï¼Œåšè‡ªå·±çš„è‹±é›„</span>
                            </h1>
                        </div>
                    </header>

                    {/* --- PERFECT PLATE LAB --- */}
                    <section id="plate" className="py-12 px-6 md:px-12 bg-green-50 border-y border-green-100 scroll-mt-24">
                        <div className="max-w-5xl mx-auto">
                            <h2 className="text-3xl font-black text-emerald-800 mb-2 flex items-center gap-3">
                                ğŸ½ï¸ å®Œç¾é¤ç›¤å¯¦é©—å®¤
                            </h2>
                            <p className="text-emerald-600 mb-8 text-lg">å­¸æœƒã€Œ211 é¤ç›¤æ³•å‰‡ã€èˆ‡ã€Œé€²é£Ÿé †åºã€ï¼Œæ‰“é€ ç„¡æ•µå¥åº·é«”è³ªï¼</p>
                            
                            <HealthyPlateLab updateHp={updateHp} fetchGeminiContent={fetchGeminiContent} fetchGeminiTTS={fetchGeminiTTS} />
                        </div>
                    </section>

                    {/* --- NEW SECTION: DETECTIVE + DIGESTIVE TRACK --- */}
                    {/* Combine into a 2-col layout or separate. Let's separate nicely. */}
                    
                    <section id="detective" className="py-12 px-6 md:px-12 bg-indigo-50 border-y border-indigo-100">
                         <div className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
                             <div className="order-2 md:order-1">
                                <h2 className="text-3xl font-black text-indigo-800 mb-2 flex items-center gap-3">
                                    ğŸ•µï¸â€â™‚ï¸ é£Ÿç‰©åµæ¢ç¤¾
                                </h2>
                                <p className="text-indigo-600 mb-6 text-lg">è¼¸å…¥é£Ÿç‰©åç¨±ï¼Œè®“ AI åµæ¢å¹«ä½ æŸ¥å‡ºå®ƒçš„å¥åº·æ©Ÿå¯†ï¼</p>
                                <div className="h-96">
                                     <FoodDetectiveSection fetchGeminiContent={fetchGeminiContent} fetchGeminiTTS={fetchGeminiTTS} />
                                </div>
                             </div>
                             <div className="order-1 md:order-2 bg-indigo-200 rounded-3xl p-8 flex items-center justify-center flex-col text-center">
                                 <div className="text-8xl mb-4">ğŸ¥œ</div>
                                 <h3 className="text-2xl font-black text-indigo-900 mb-2">å°å¿ƒéš±è—é™·é˜±ï¼</h3>
                                 <p className="text-indigo-700 font-bold">æœ‰äº›é£Ÿç‰©çœ‹èµ·ä¾†å¾ˆå¥½åƒï¼Œå…¶å¯¦è—è‘—å¤§å£è›‹ï¼ˆç³–åˆ†ã€è‰²ç´ ï¼‰ï¼å¿«ç”¨åµæ¢é¡ç…§ä¸€ç…§ï¼</p>
                             </div>
                         </div>
                    </section>

                    {/* --- SECTION: DIGESTIVE TRACK (Full Width) --- */}
                    <section id="digest" className="py-12 px-6 md:px-12 bg-pink-50 border-y border-pink-100">
                        <div className="max-w-4xl mx-auto">
                            <h2 className="text-3xl font-black text-pink-700 mb-2 flex items-center gap-3">
                                ğŸ« è…¸èƒƒé“å¤§å†’éšª
                            </h2>
                            <p className="text-pink-600 mb-8 text-lg">å¤©ç„¶é£Ÿç‰©å¥½æ¶ˆåŒ–ï¼ŒåŠ å·¥é£Ÿå“æœƒå¡å¡ï¼</p>
                            
                            <div className="bg-white rounded-3xl p-8 shadow-lg border border-pink-200 space-y-8">
                                {/* Good Food */}
                                <div className="group relative cursor-pointer">
                                    <div className="flex justify-between text-sm font-bold text-gray-400 mb-2">
                                        <span>å…¥å£</span>
                                        <span>å¤©ç„¶çº–ç¶­åŠ é€Ÿæ¶ˆåŒ– âœ¨</span>
                                        <span>å‡ºå£</span>
                                    </div>
                                    <div className="h-6 bg-gray-100 rounded-full overflow-hidden relative">
                                        <div className="absolute inset-0 bg-[linear-gradient(90deg,transparent_50%,#fce7f3_50%)] bg-[length:20px_20px]"></div>
                                    </div>
                                    <div className="absolute top-6 left-0 text-4xl transition-all duration-[1500ms] ease-linear group-hover:left-[95%]">
                                        ğŸ
                                    </div>
                                </div>

                                {/* Bad Food */}
                                <div className="group relative cursor-pointer pt-4">
                                    <div className="flex justify-between text-sm font-bold text-gray-400 mb-2">
                                        <span>å…¥å£</span>
                                        <span className="text-red-400">æ²¹è„‚å †ç©ï¼Œæ¶ˆåŒ–å›°é›£ âš ï¸</span>
                                        <span>å‡ºå£</span>
                                    </div>
                                    <div className="h-6 bg-gray-100 rounded-full overflow-hidden relative">
                                        <div className="absolute inset-0 bg-[linear-gradient(90deg,transparent_50%,#fee2e2_50%)] bg-[length:20px_20px]"></div>
                                        <div className="absolute left-1/3 top-0 h-full w-12 bg-yellow-300 opacity-60"></div>
                                        <div className="absolute left-2/3 top-0 h-full w-12 bg-yellow-300 opacity-60"></div>
                                    </div>
                                    <div className="absolute top-10 left-0 text-4xl transition-all duration-[6000ms] ease-linear group-hover:left-[95%] group-hover:stuck-effect">
                                        ğŸ§§
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* --- SECTION: FACTORY --- */}
                    <section id="factory" className="py-16 px-6 md:px-12 bg-slate-900 text-white">
                        <div className="max-w-4xl mx-auto">
                            <h2 className="text-3xl font-black text-yellow-400 mb-12 text-center">ğŸ­ ææ€–çœŸç›¸å·¥å» </h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 relative">
                                <div className="hidden md:block absolute top-1/2 left-0 w-full h-1 bg-slate-700 -z-10 transform -translate-y-1/2"></div>
                                {[
                                    { step: 1, title: "ä¸æ˜ç²‰æœ«", desc: "éºµç²‰æ··åˆ 12 ç¨®åŒ–å­¸æ·»åŠ ç²‰æœ«", color: "bg-gray-500", icon: "â˜ ï¸" },
                                    { step: 2, title: "è‰²ç´ æ²¹æ¾¡", desc: "æµ¸æ³¡åœ¨åè¦†ä½¿ç”¨çš„ç´…æ²¹ä¸­æŸ“è‰²", color: "bg-red-600", icon: "ğŸ©¸" },
                                    { step: 3, title: "å»‰åƒ¹åŒ…è£", desc: "åŒ…è£æˆåªéœ€ 10 å…ƒçš„èª˜äººé›¶é£Ÿ", color: "bg-yellow-500", icon: "ğŸ" }
                                ].map((item) => (
                                    <div key={item.step} className="bg-slate-800 p-6 rounded-2xl border border-slate-700 relative hover:transform hover:-translate-y-2 transition-transform duration-300">
                                        <div className={`w-12 h-12 ${item.color} rounded-full flex items-center justify-center text-2xl font-bold mb-4 border-4 border-slate-900 absolute -top-6 left-6`}>
                                            {item.step}
                                        </div>
                                        <div className="mt-4 text-center">
                                            <div className="text-4xl mb-3">{item.icon}</div>
                                            <h3 className="text-xl font-bold mb-2">{item.title}</h3>
                                            <p className="text-slate-400 text-sm">{item.desc}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    {/* --- DUAL GRID: BLOOD + LAB --- */}
                    <section id="simulations" className="py-12 px-6 md:px-12 bg-white">
                        <div className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-red-50 rounded-3xl p-6 border border-red-100 shadow-sm">
                                <h2 className="text-2xl font-bold text-red-800 mb-4">ğŸ©¸ è¡€ç®¡é˜»å¡æ¨¡æ“¬</h2>
                                <BloodVesselSection />
                            </div>
                            <div className="bg-slate-50 rounded-3xl p-6 border border-slate-200 shadow-sm">
                                <h2 className="text-2xl font-bold text-slate-800 mb-4">ğŸ§ª è¾£æ¢ä»£åƒ¹è¨ˆç®—</h2>
                                <LatiaoLab updateHp={updateHp} />
                            </div>
                        </div>
                    </section>

                    {/* --- DUAL GRID: FACE + TIME --- */}
                    <section id="effects" className="py-12 px-6 md:px-12 bg-orange-50">
                         <div className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-white/60 rounded-3xl p-6 border border-orange-200">
                                <h2 className="text-2xl font-bold text-orange-800 mb-4">ğŸ§Ÿ è®Šè‡‰æ¨¡æ“¬å™¨</h2>
                                <FaceSimulator />
                            </div>
                            <div className="bg-slate-800 rounded-3xl p-6 border border-slate-700 text-white">
                                <h2 className="text-2xl font-bold text-cyan-400 mb-4">â³ æ™‚å…‰ç…§ç›¸é¤¨ & æœªä¾†å°è©±</h2>
                                <TimeMachineSection age={timeMachineAge} setAge={setTimeMachineAge} hp={hp} fetchGeminiContent={fetchGeminiContent} />
                            </div>
                         </div>
                    </section>

                    {/* --- GAME SECTION --- */}
                    <section id="game" className="py-16 px-6 md:px-12 bg-indigo-900 text-white relative overflow-hidden">
                        <div className="max-w-4xl mx-auto">
                            <MiniGame updateHp={updateHp} />
                        </div>
                    </section>

                    {/* --- DUAL GRID: CHAT + BOSS --- */}
                    <section className="py-12 px-6 md:px-12 bg-slate-50">
                        <div className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div id="chat" className="bg-white rounded-3xl p-6 shadow-md border border-indigo-100">
                                <h2 className="text-2xl font-bold text-indigo-700 mb-4">ğŸ’¬ æ‹’çµ•èª˜æƒ‘é“å ´</h2>
                                <ChatDojoSection fetchGeminiContent={fetchGeminiContent} fetchGeminiTTS={fetchGeminiTTS} updateHp={updateHp} />
                            </div>
                            <div id="boss" className="bg-slate-900 rounded-3xl p-6 shadow-md border border-slate-700 text-white">
                                <h2 className="text-2xl font-bold text-red-500 mb-4">âš”ï¸ AI é­”ç‹æœ€çµ‚æˆ°</h2>
                                <BossBattle updateHp={updateHp} fetchGeminiContent={fetchGeminiContent} />
                            </div>
                        </div>
                    </section>

                    {/* --- HERO STORY SECTION (NEW) --- */}
                    <section id="hero" className="py-16 px-6 md:px-12 bg-white">
                        <div className="max-w-4xl mx-auto">
                            <HeroStorySection fetchGeminiContent={fetchGeminiContent} />
                        </div>
                    </section>

                    {/* --- PLEDGE --- */}
                    <PledgeSection />

                    <footer className="bg-white border-t border-slate-200 text-center py-12">
                        <p className="text-slate-400 font-bold">Health Adventure V3.0 AI Edition</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>